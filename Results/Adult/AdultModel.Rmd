---
title: "Adult Dataset"
author: "Jianhui Gao"
date: "2023-07-25"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(kableExtra)
library(matrixStats)
library(dplyr)
library(tidyr)
library(ggplot2)
```

# Description

The total number of rows are 45,222. I am randomly selecting 1,400 rows as labeled data. 700 are allocated to the training, and 700 are reserved for testing. I used lasso for model building. I repeated the sampling of labeled data 10,000 times and averaged the results. 

```{r}
dat <- data.table::fread("Data/Adult/adult.data",
  na.strings = "?"
)
test <- data.table::fread("Data/Adult/adult.test",
  na.strings = "?"
)
test$V15 <- test$V15 %>% gsub("\\.", "", .)

dat <- rbind(dat, test)

colnames(dat) <- c(
  "age", "workclass", "fnlwgt", "education",
  "education_num", "marital_status", "occupation",
  "relationship", "race", "sex", "capital_gain",
  "capital_loss", "hours_per_week", "native_country",
  "income_per_year"
)

dat <- dat %>% drop_na()
```

# Results

```{r}
getwd()
results <- readRDS("Results/Adult/adult_logistic_sex_n=1000.rds")
oracle_est <- do.call(rbind, lapply(results, function(ll) ll$oracle_est))  %>% group_by(Metric) %>% summarise_all(function(x) mean(x, na.rm = TRUE)) %>% pivot_longer(
  cols = -c(Metric),
  names_to = "Group",
  values_to = "Est"
)
oracle_var <- do.call(rbind, lapply(results, function(ll) ll$oracle_var)) %>% group_by(Metric) %>% summarise_all(function(x) mean(x, na.rm = TRUE)) %>% pivot_longer(
  cols = -c(Metric),
  names_to = "Group",
  values_to = "Var"
)
oracle <- oracle_est %>% left_join(oracle_var, by = c("Metric", "Group")) %>% mutate(Method = "Oracle")
sup_est <- do.call(rbind, lapply(results, function(ll) ll$sup_est)) %>% group_by(Metric) %>% summarise_all(function(x) mean(x, na.rm = TRUE)) %>% pivot_longer(
  cols = -c(Metric),
  names_to = "Group",
  values_to = "Est"
)
sup_var <- do.call(rbind, lapply(results, function(ll) ll$sup_var)) %>% group_by(Metric) %>% summarise_all(function(x) mean(x, na.rm = TRUE)) %>% pivot_longer(
  cols = -c(Metric),
  names_to = "Group",
  values_to = "Var"
)
sup <- sup_est %>% left_join(sup_var, by = c("Metric", "Group")) %>% mutate(Method = "Supervised")
ss_est <- do.call(rbind, lapply(results, function(ll) ll$inf_est)) %>% group_by(Metric) %>% summarise_all(function(x) mean(x, na.rm = TRUE)) %>% pivot_longer(
  cols = -c(Metric),
  names_to = "Group",
  values_to = "Est"
)
ss_var <- do.call(rbind, lapply(results, function(ll) ll$inf_var)) %>% group_by(Metric) %>% summarise_all(function(x) mean(x, na.rm = TRUE)) %>% pivot_longer(
  cols = -c(Metric),
  names_to = "Group",
  values_to = "Var"
)
ss <- ss_est %>% left_join(ss_var, by = c("Metric", "Group")) %>% mutate(Method = "Infairness")
```


```{r}
rbind(oracle, sup, ss) %>% 
  filter(!Metric %in% c("mu", "F1", "FNR", "FPR", "NPV", "PPV")) %>%
  mutate(Method = factor(Method, levels = c("Oracle", "Supervised", "Infairness"))) %>%
  mutate(Group = factor(Group, levels = c("GroupFemale", "GroupMale", "Delta"), labels = c("Female", "Male", "Delta"))) %>%
  ggplot(aes(x = Metric, y = Est, fill = Method)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Est - 1.96* sqrt(Var), ymax = Est + 1.9*sqrt(Var)), position = position_dodge(width = 0.9), width = 0.25) +
  facet_wrap(~Group, ncol = 3) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1))+
  xlab("") +
  ylab("Estimated Value") +
  ggsci::scale_fill_nejm()
ggsave("Results/Adult/adult_logistic.png", width = 6, height = 4, units = "in")
```

```{r}
sup <- cbind(sup[,1:2], bias = sup$Est - oracle$Est) %>%
  left_join(sup, by = c("Metric", "Group")) %>%
  mutate(MSE = bias^2 + Var)
ss <- cbind(ss[,1:2], bias = ss$Est - oracle$Est) %>%
  left_join(ss, by = c("Metric", "Group")) %>%
  mutate(MSE = bias^2 + Var)
re <- cbind(sup[,1:2], re = sup$MSE/ss$MSE, method = "Infairness")

re  %>% 
  filter(!Metric %in% c("mu", "F1", "FNR", "FPR", "NPV", "PPV")) %>%
  mutate(Group = factor(Group, levels = c("GroupFemale", "GroupMale", "Delta"), labels = c("Female", "Male", "Delta"))) %>% ggplot(aes(x = Metric, y = re, fill = Group)) +
    geom_bar(stat = "identity", position = "dodge") +
    theme_bw() +
    theme(legend.position = "bottom") +
    geom_abline(intercept = 1, slope = 0, linetype = "dashed") +
    ylab("Relative Efficiency \n (Supervised:Infairness)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))+
    xlab("")+
    ggsci::scale_fill_lancet()+
    ylim(0, 2)
ggsave("Results/Adult/re_adult_logistic.png", width = 6, height = 4, units = "in")
```




\clearpage

